name: Deploy to Google Cloud Run

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGION: us-central1
  REGISTRY: us-central1-docker.pkg.dev

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linter
      run: npm run lint
      
    - name: Build TypeScript
      run: npm run build

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment: staging
    
    permissions:
      contents: read
      id-token: write
    
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_STAGING }}
      SERVICE_NAME: organicfreshcoffee-game-server-staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run Database Migrations (Staging)
      run: |
        echo "üóÑÔ∏è Running database migrations for staging..."
        if ! npm run migrate:up; then
          echo "‚ùå Migration failed - stopping deployment"
          exit 1
        fi
        echo "‚úÖ Migrations completed successfully"
      env:
        MONGODB_URI: ${{ secrets.MONGODB_URI_STAGING }}
        MONGODB_DB_NAME: gamedb
      
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER_STAGING }}
        service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL_STAGING }}
        
    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.REGISTRY }}
      
    - name: Build Docker image
      run: |
        docker build -f Dockerfile.prod \
          -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/game-server-staging/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/game-server-staging/${{ env.SERVICE_NAME }}:latest \
          .
          
    - name: Push Docker image
      run: |
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/game-server-staging/${{ env.SERVICE_NAME }}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/game-server-staging/${{ env.SERVICE_NAME }}:latest
        
    - name: Deploy to Cloud Run (Staging)
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/game-server-staging/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          --region ${{ env.REGION }} \
          --platform managed \
          --allow-unauthenticated \
          --port 3002 \
          --memory 1Gi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 10 \
          --concurrency 1000 \
          --timeout 3600 \
          --set-env-vars NODE_ENV=staging,AUTH_SERVER_URL=${{ secrets.AUTH_SERVER_URL_STAGING }},MONGODB_URI=${{ secrets.MONGODB_URI_STAGING }},CLIENT_URL=${{ secrets.CLIENT_URL_STAGING }}
          
    - name: Get Cloud Run URL (Staging)
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --format 'value(status.url)')
        echo "üöÄ Staging service deployed successfully!"
        echo "üì± Service URL: $SERVICE_URL"
        echo "üîå WebSocket URL: ${SERVICE_URL/https:/wss:}/game"
        echo "‚ù§Ô∏è  Health Check: $SERVICE_URL/health"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment: production
    
    permissions:
      contents: read
      id-token: write
    
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      SERVICE_NAME: organicfreshcoffee-game-server
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run Database Migrations (Production)
      run: |
        echo "üóÑÔ∏è Running database migrations for production..."
        if ! npm run migrate:up; then
          echo "‚ùå Migration failed - stopping deployment"
          exit 1
        fi
        echo "‚úÖ Migrations completed successfully"
      env:
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
        MONGODB_DB_NAME: gamedb
      
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}
        
    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.REGISTRY }}
      
    - name: Build Docker image
      run: |
        docker build -f Dockerfile.prod \
          -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/game-server/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          -t ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/game-server/${{ env.SERVICE_NAME }}:latest \
          .
          
    - name: Push Docker image
      run: |
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/game-server/${{ env.SERVICE_NAME }}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/game-server/${{ env.SERVICE_NAME }}:latest
        
    - name: Deploy to Cloud Run (Production)
      run: |
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/game-server/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          --region ${{ env.REGION }} \
          --platform managed \
          --allow-unauthenticated \
          --port 3002 \
          --memory 1Gi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 10 \
          --concurrency 1000 \
          --timeout 3600 \
          --set-env-vars NODE_ENV=production,AUTH_SERVER_URL=${{ secrets.AUTH_SERVER_URL }},MONGODB_URI=${{ secrets.MONGODB_URI }},CLIENT_URL=${{ secrets.CLIENT_URL }}
          
    - name: Get Cloud Run URL (Production)
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --format 'value(status.url)')
        echo "üöÄ Production service deployed successfully!"
        echo "üì± Service URL: $SERVICE_URL"
        echo "üîå WebSocket URL: ${SERVICE_URL/https:/wss:}/game"
        echo "‚ù§Ô∏è  Health Check: $SERVICE_URL/health"
